var docMax=1;var docTotal=0;var docDel=0;$(function(){var a=document.getElementById("uploadifyTest");if(!a.files){if(!checkFlashPlayer().hasFlashPlayer){var b='<p>\u60a8\u672a\u5b89\u88c5FLASH\u63a7\u4ef6\uff0c\u65e0\u6cd5\u4e0a\u4f20\uff01\u8bf7<a style="color:#00a1ea;text-decoration: underline;"  href="https://get.adobe.com/cn/flashplayer/" target="_blank">\u5b89\u88c5FLASH\u63a7\u4ef6</a>\u6216\u5347\u7ea7\u6d4f\u89c8\u5668\u540e\u518d\u8bd5\u3002</p>';$("#def_content_tr td").append(b);$("#open_btn").hide()}}$("#open_btn").click(function(){if(isEmptyValue($("#uId").text())){loginDiv();return false}validateIsOnline({confirmHandle:function(){if(docTotal>=docMax){alertFail("\u4e00\u6b21\u6700\u591a\u4e0a\u4f20"+docMax+"\u4e2a\u6587\u4ef6\uff01");return false}ShowDiv("MyDiv","fade");$("#upload_before").show();$(".div_promptMsg").show();$(".div_errMsg").text("");$(".div_errMsg").hide();$("#uploadifyDiv").html("");$("#uploadifyDiv").append('<input id="uploadify" name="uploadify" type="file"/>');$("#upload_after").html("");$("#upload_after").hide();tradeUploadify()}})});$("#submit_btn").click(function(){if(isEmptyValue($("#uId").text())){loginDiv();return false}validateIsOnline({confirmHandle:function(){saveTask()}})})});function tradeUploadify(){var a=document.getElementById("uploadify");if(a.files){$("#uploadify").change(function(){fileUpload(this.value,a)})}else{$("#select_btn").hide();$("#uploadifyDiv").show();$("#uploadify").uploadify({swf:"../static/js/uploadify/uploadify.swf",uploader:"../print/getImageStr.action",buttonText:"\u4e0a\u4f20\u56fe\u7247",buttonClass:"uploadifyClass",fileObjName:"file",height:40,width:150,fileTypeDesc:"\u652f\u6301\u7684\u683c\u5f0f\uff1a",fileTypeExts:"*.jpg; *.jpeg; *.bmp; *.JPG; *.JPEG; *.BMP;",auto:true,multi:false,onInit:function(){$("#uploadify-queue").hide()},onSelect:function(){startWait()},onUploadSuccess:function(c,e,b){$("#upload_after").html("");$("#upload_before").hide();$("#upload_after").show();var d='<div class="clearfix"><div style="width:15%;float:left;visibility:hidden;">\u586b\u5145\u533a\u57df</div><div id="myCanvasDv" class="img_yulan" style="width:70%;float:left;margin: 0 auto;"><img id="preview" name="preview"/></div></div><div style="width:15%;float:left;"></div></div><div class="clearfix" align="center" style="margin-top:20px;"><div id="confirm_btn" class="confirm_btn" onclick="confirmImage()">\u786e\u5b9a</div><div style="width:50px;height:40px;visibility:hidden;display:inline-block;">\u586b\u5145\u533a\u57df</div><div id="reUpload_cancel_btn" class="reUpload_cancel_btn"  onclick="closeWindow()">\u53d6\u6d88</div></div>';$("#upload_after").html(d);fileSelectHandlerLowIe(0.714,e);closeWait()},onQueueComplete:function(){closeWait()},onUploadError:function(c,f,e,d,b){closeWait();alertFail(d)}})}}function fileUpload(c,a){$(".div_promptMsg").show();$(".div_errMsg").html("");$(".div_errMsg").hide();$("#upload_after").html("");if(!isImageFile(c)){$(".div_promptMsg").hide();$(".div_errMsg").show();$(".div_errMsg").text("\u9009\u62e9\u7684\u6587\u4ef6\u683c\u5f0f\u9519\u8bef(\u53ea\u80fd\u9009\u62e9jpg,jpeg,bmp)\uff01");return false}else{$(".div_errMsg").hide()}$("#upload_before").hide();$("#upload_after").show();var b='<div class="clearfix"><div style="width:15%;float:left;visibility:hidden;">\u586b\u5145\u533a\u57df</div><div id="myCanvasDv" class="img_yulan" style="width:70%;float:left;margin: 0 auto;"><img id="preview" name="preview"/></div></div><div style="width:15%;float:left;"></div></div><div align="center" style="margin-top:20px;"><div id="confirm_btn" class="confirm_btn" onclick="confirmImage()">\u786e\u5b9a</div><div style="width:50px;height:40px;visibility:hidden;display:inline-block;">\u586b\u5145\u533a\u57df</div><div id="reUpload_cancel_btn" class="reUpload_cancel_btn"  onclick="closeWindow()">\u53d6\u6d88</div></div>';$("#upload_after").html(b);fileSelectHandler(0.714,a)}function confirmImage(){if(isEmptyValue($("#w").val())||parseFloat($("#w").val())<=0){alertFail("\u6ca1\u6709\u88c1\u526a\u56fe\u7247\uff01");return false}startWait();if(!isLower10){var data=new FormData();data.append("file",$("#uploadify")[0].files[0]);data.append("x",$("#x").val());data.append("y",$("#y").val());data.append("w",$("#w").val());data.append("h",$("#h").val());data.append("resWidth",$("#resWidth").val());data.append("resHeight",$("#resHeight").val());data.append("horOrPer",$("#horOrPer").val());upload(data,"../print/uploadImage.action")}else{var formData=$("#form").serialize();$.ajax({type:"POST",url:"../print/uploadImageWithStr.action",cache:false,data:formData,dataType:"json",success:function(data){closeWait();if(data.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}data=data.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){data=eval("("+data.rsData+")");setDocumentResult(data);docTotal++;$(".open_btn").hide();closeWindow()}else{alertFail("\u4e0a\u4f20\u6587\u4ef6\u5931\u8d25\uff01");return false}}})}}function select(){$("#uploadify").click()}function uploadComplete(evt){closeWait();var result=evt.target.responseText;if(result.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}result=eval("("+result+")");data=result.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){data=eval("("+data.rsData+")");setDocumentResult(data);docTotal++;$(".open_btn").hide();closeWindow()}else{alertFail("\u4e0a\u4f20\u6587\u4ef6\u5931\u8d25\uff01");return false}}function isImageFile(c){var a=["jpg","jpeg","bmp"];if(!isEmptyValue(c)){var d=c.substring(c.lastIndexOf(".")+1,c.length);if(!isEmptyValue(d)){for(var b=0;b<a.length;b++){if(d.toLowerCase()==a[b]){return true}}}}return false}function closeWindow(){CloseDiv("MyDiv","fade")}function setDocumentResult(d){var g=docTotal;var c='<tr id="image'+g+'"><td>'+getCutStr(d.fileName)+'</td><td><span id="errMsg'+g+'" style="color:red">'+d.ErrMsg+"</span></td>";if(d.ErrCode=="0"){c+='<td><img id="showImage'+g+'" src="" /></td><td><p><label><input type="radio" name="printTypes'+g+'"onclick="setPage(this)" value="0" checked="checked"/><span style="font-weight: normal;cursor: pointer;">\u4e00\u5bf8\u7167\u7247</span></label></p><p><label><input type="radio" name="printTypes'+g+'"onclick="setPage(this)" value="1"/><span style="font-weight: normal;cursor: pointer;">\u4e8c\u5bf8\u7167\u7247</span></label></p></td><td><input type="text" size="5" id="_docnum'+g+'" name="_docnum'+g+'"onKeyUp="numVerify(this)" onBlur="numberBlur(this)" value="1"  style="width:40px;border: 1px solid #e4e4e4;"/></td><td><span id="unit_price'+g+'"></span></td>';c+='<td><a id="_del'+g+'" href="javascript:void(0)" onclick="delDoc(this)">\u5220\u9664</a><div id="hidVal'+g+'" style="display:none"></div></td></tr>';$("#tbodyContent").append(c);$("#def_content_tr").hide();var a="<input id='docsize"+g+"' type='hidden' value=''>";var e="<input id='add_direction"+g+"' type='hidden' value='0'>";var h="<input id='fileName"+g+"' type='hidden' value='"+d.fileName+"'>";var b="<input id='add_pdffilename"+g+"' type='hidden' value='"+d.fileRealName+"'>";$("#hidVal"+g).append(a+e+h+b);$("#showImage"+g).attr("src","data:;base64,"+d.str_img);var f=getWidthAndHeight($("#showImage"+g).width(),$("#showImage"+g).height(),100,100);$("#showImage"+g).css("width",f[0]+"px");$("#showImage"+g).css("height",f[1]+"px");setBaseMoney(g)}else{c+='<td colspan="4"></td>';c+='<td><a id="_del'+g+'" href="javascript:void(0)" onclick="delDoc(this)">\u5220\u9664</a><div id="hidVal'+g+'" style="display:none"></div></td></tr>';$("#tbodyContent").append(c);$("#def_content_tr").hide()}}function setBaseMoney(i){var printTypes=$("input[name=printTypes"+i+"]:checked").val();var a_size="";var a_color="2";var a_format="0";if(printTypes=="0"){a_size="INCH1"}else{a_size="INCH2"}$("#docsize"+i).val(a_size);$.ajax({type:"post",async:false,url:"../print/getPrice.action",data:{size:a_size,color:a_color,format:a_format},success:function(data){if(data.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}data=data.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){var rsData=eval("("+data.rsData+")");$("#baseMoney"+i).val(parseFloat(rsData.price).toFixed(2));$("#unit_price"+i).html(parseFloat(rsData.price).toFixed(2))}}})}function setPage(a){var b=parseInt(a.getAttribute("name").charAt(a.getAttribute("name").length-1));setBaseMoney(b)}function numVerify(a){a.value=a.value.replace(/[^\d]/g,"");if(a.value==""||a.value=="0"){return}}function numberBlur(a){if(a.value==""||a.value=="0"){a.value="1"}}function delDoc(d){var e=parseInt(d.getAttribute("id").charAt(d.getAttribute("id").length-1));$("#image"+e).remove();var c=$("#tbodyContent").children().length;if(c==2){$("#def_content_tr").show()}for(var b=(e+1);b<docTotal;b++){var a=b-1;$("#image"+b).attr("id","image"+a);$("#errMsg"+b).attr("id","errMsg"+a);$("#showImage"+b).attr("id","showImage"+a);$('input[name="printTypes'+b+'"]').attr("name","printTypes"+a);$("#_docnum"+b).attr("id","_docnum"+a);$('input[name="_docnum'+b+'"]').attr("name","_docnum"+a);$("#unit_price"+b).attr("id","unit_price"+a);$("#_del"+b).attr("id","_del"+a);$("#hidVal"+b).attr("id","hidVal"+a);$("#docsize"+b).attr("id","docsize"+a);$("#add_direction"+b).attr("id","add_direction"+a);$("#fileName"+b).attr("id","fileName"+a);$("#add_pdffilename"+b).attr("id","add_pdffilename"+a)}docTotal--;$(".open_btn").show()}function delAllDoc(){for(var a=0;a<docTotal;a++){$("#image"+a).remove()}docTotal=0;$("#def_content_tr").show();$(".open_btn").show()}function saveTask(){if(docTotal<=0){alertWarning("\u8bf7\u9009\u62e9\u4e0a\u4f20\u7167\u7247\uff01");return false}var errTotal=0;for(var i=0;i<docTotal;i++){if($("#errMsg"+i).html().indexOf("\u6210\u529f")==-1){errTotal++}}if(errTotal==docTotal){alertWarning("\u6ca1\u6709\u6210\u529f\u4e0a\u4f20\u7684\u7167\u7247\uff0c\u8bf7\u4e0a\u4f20\u6210\u529f\u540e\u518d\u6b21\u63d0\u4ea4\uff01");return false}for(var i=0;i<docTotal;i++){if($("#errMsg"+i).html().indexOf("\u6210\u529f")==-1){continue}if($("input:radio[name=printTypes"+i+"]:checked").val()==undefined){alertWarning("\u8bf7\u9009\u62e9\u7c7b\u578b\uff01");return false}}startWait();var present="";var successNum=0;for(var i=0;i<docTotal;i++){if($("#errMsg"+i).html().indexOf("\u6210\u529f")==-1){continue}var a_color="2";var a_format="0";var a_size=$("#docsize"+i).val();var allnums="";var alldirection="";var filePage="1";var pdfnames="";var uploadifyFileName="";allnums=$("#_docnum"+i).val();alldirection=$("#add_direction"+i).val();pdfnames=$("#add_pdffilename"+i).val();uploadifyFileName=$("#fileName"+i).val();$.ajax({type:"post",async:false,url:"../print/createPrintTask.action",dataType:"json",data:{fileName:uploadifyFileName,fileRealName:pdfnames,filePage:filePage,color:a_color,format:a_format,size:a_size,number:allnums},success:function(data){if(data.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}else{data=data.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){closeWait();successNum++}else{if(data.rsType==TYPE_RESULT.FAIL){closeWait();alertFail("\u521b\u5efa\u6253\u5370\u4efb\u52a1\u5931\u8d25\uff01");return false}else{if(data.rsType==TYPE_RESULT.WARN){var rsData=eval("("+data.rsData+")");closeWait();alertFail(rsData.ErrMsg);return false}}}}}})}if(successNum==docTotal-errTotal){closeWait();delAllDoc();alertSuccess("\u6253\u5370\u4efb\u52a1\u63d0\u4ea4\u6210\u529f,\u8bf7\u5230\u4e91\u6253\u5370\u7ec8\u7aef\u673a\u53d6\u4ef6!")}};
