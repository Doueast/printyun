var docMax=1;var docTotal=0;var docDel=0;$(function(){var a=document.getElementById("uploadifyTest");if(!a.files){if(!checkFlashPlayer().hasFlashPlayer){var b='<p>\u60a8\u672a\u5b89\u88c5FLASH\u63a7\u4ef6\uff0c\u65e0\u6cd5\u4e0a\u4f20\uff01\u8bf7<a style="color:#00a1ea;text-decoration: underline;"  href="https://get.adobe.com/cn/flashplayer/" target="_blank">\u5b89\u88c5FLASH\u63a7\u4ef6</a>\u6216\u5347\u7ea7\u6d4f\u89c8\u5668\u540e\u518d\u8bd5\u3002</p>';$("#def_content_tr td").append(b);$("#idCard_positive_btn").hide();$("#idCard_reverse_btn").hide()}}$("#idCard_positive_btn").click(function(){if(isEmptyValue($("#uId").text())){loginDiv();return false}validateIsOnline({confirmHandle:function(){ShowDiv("MyDiv","fade");$("#upload_before").show();$(".div_promptMsg").show();$(".div_errMsg").html("");$(".div_errMsg").hide();$("#uploadifyDiv").html("");$("#uploadifyDiv").append('<input id="uploadify" name="uploadify" type="file"/>');$("#upload_after").html("");$("#upload_after").hide();$("#div_title").text("\u4e0a\u4f20\u8eab\u4efd\u8bc1\u6b63\u9762\u7167");$("#idcardAB").val("A");tradeUploadify()}})});$("#idCard_reverse_btn").click(function(){if(isEmptyValue($("#uId").text())){loginDiv();return false}validateIsOnline({confirmHandle:function(){if(isEmptyValue($("#fileRealName1").val())){alertFail("\u8bf7\u5148\u4e0a\u4f20\u6b63\u9762\u7167\uff01");return false}ShowDiv("MyDiv","fade");$("#upload_before").show();$(".div_promptMsg").show();$(".div_errMsg").html("");$(".div_errMsg").hide();$("#uploadifyDiv").html("");$("#uploadifyDiv").append('<input id="uploadify" name="uploadify" type="file"/>');$("#upload_after").html("");$("#upload_after").hide();$("#div_title").text("\u4e0a\u4f20\u8eab\u4efd\u8bc1\u53cd\u9762\u7167");$("#idcardAB").val("B");tradeUploadify()}})});$("#submit_btn").click(function(){if(isEmptyValue($("#uId").text())){loginDiv();return false}validateIsOnline({confirmHandle:function(){saveTask()}})})});function tradeUploadify(){var a=document.getElementById("uploadify");if(a.files){$("#uploadify").change(function(){fileUpload(this.value,a)})}else{$("#select_btn").hide();$("#uploadifyDiv").show();$("#uploadify").uploadify({swf:"../static/js/uploadify/uploadify.swf",uploader:"../print/getImageStr.action",buttonText:"\u4e0a\u4f20\u56fe\u7247",buttonClass:"uploadifyClass",fileObjName:"file",height:40,width:150,fileTypeDesc:"\u652f\u6301\u7684\u683c\u5f0f\uff1a",fileTypeExts:"*.jpg; *.jpeg; *.bmp; *.JPG; *.JPEG; *.BMP;",auto:true,multi:false,onInit:function(){$("#uploadify-queue").hide()},onSelect:function(b){startWait();$("#fileName").val(b.fileName)},onUploadSuccess:function(c,e,b){$("#upload_after").html("");$("#upload_before").hide();$("#upload_after").show();var d='<div class="clearfix" style="position:relative;"><div style="width:15%;float:left;visibility:hidden;">\u586b\u5145\u533a\u57df</div><div id="myCanvasDv" class="img_yulan" style="width:70%;float:left;"><img id="preview" name="preview"/></div><div style="width:15%;height:100%;float:left;"><div style="position:absolute;top:50%;margin-top:-38px;"><div style="width:100px;height:2em;line-height:2em;background:#FF6802;cursor: pointer;margin-bottom:20px;color:#ffffff;" onclick="reversal(1.61)">\u6a2a\u5411\u526a\u88c1</div><div style="width:100px;height:2em;line-height:2em;background:#00acef;cursor: pointer;color:#ffffff;" onclick="reversal(0.631)">\u7eb5\u5411\u526a\u88c1</div></div></div></div><div class="clearfix" align="center"><div id="confirm_btn" class="confirm_btn" onclick="confirmImage()">\u786e\u5b9a</div><div style="width:50px;visibility:hidden;display:inline-block;">\u586b\u5145\u533a\u57df</div><div id="reUpload_cancel_btn" class="reUpload_cancel_btn" onclick="closeWindow()">\u53d6\u6d88</div></div>';$("#upload_after").html(d);fileSelectHandlerLowIe(1.61,e);closeWait()},onQueueComplete:function(){closeWait()},onUploadError:function(c,f,e,d,b){closeWait()}})}}function fileUpload(c,a){$(".div_promptMsg").show();$(".div_errMsg").html("");$(".div_errMsg").hide();$("#upload_after").html("");if(!isImageFile(c)){$(".div_promptMsg").hide();$(".div_errMsg").show();$(".div_errMsg").text("\u9009\u62e9\u7684\u6587\u4ef6\u683c\u5f0f\u9519\u8bef(jpg,jpeg,bmp)\uff01");return false}else{$(".div_errMsg").hide()}$("#upload_before").hide();$("#upload_after").show();var b='<div class="clearfix" style="position:relative;"><div style="width:15%;float:left;visibility:hidden;">\u586b\u5145\u533a\u57df</div><div id="myCanvasDv" class="img_yulan" style="width:70%;float:left;"><img id="preview" name="preview"/></div><div style="width:15%;height:100%;float:left;"><div style="position:absolute;top:50%;margin-top:-38px;"><div style="width:100px;height:2em;line-height:2em;background:#FF6802;cursor: pointer;margin-bottom:20px;color:#ffffff;" onclick="reversal(1.61)">\u6a2a\u5411\u526a\u88c1</div><div style="width:100px;height:2em;line-height:2em;background:#00acef;cursor: pointer;color:#ffffff;" onclick="reversal(0.631)">\u7eb5\u5411\u526a\u88c1</div></div></div></div><div class="clearfix" align="center"><div id="confirm_btn" class="confirm_btn" onclick="confirmImage()">\u786e\u5b9a</div><div style="width:50px;visibility:hidden;display:inline-block;">\u586b\u5145\u533a\u57df</div><div id="reUpload_cancel_btn" class="reUpload_cancel_btn" onclick="closeWindow()">\u53d6\u6d88</div></div>';$("#upload_after").html(b);fileSelectHandler(1.61,a)}function confirmImage(){if(isEmptyValue($("#w").val())||parseFloat($("#w").val())<=0){alertFail("\u6ca1\u6709\u88c1\u526a\u56fe\u7247\uff01");return false}startWait();if(!isLower10){var data=new FormData();data.append("file",$("#uploadify")[0].files[0]);data.append("idcardAB",$("#idcardAB").val());data.append("x",$("#x").val());data.append("y",$("#y").val());data.append("w",$("#w").val());data.append("h",$("#h").val());data.append("resWidth",$("#resWidth").val());data.append("resHeight",$("#resHeight").val());data.append("fileRealName1",$("#fileRealName1").val());data.append("horOrPer",$("#horOrPer").val());upload(data,"../print/uploadIdentity.action")}else{var formData=$("#form").serialize();$.ajax({type:"POST",url:"../print/uploadIdentityWithStr.action?fileRealName1="+$("#fileRealName1").val(),cache:false,data:formData,dataType:"json",success:function(data){closeWait();if(data.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}data=data.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){data=eval("("+data.rsData+")");setDocumentResult(data);docTotal=docMax;closeWindow()}else{alertFail("\u4e0a\u4f20\u6587\u4ef6\u5931\u8d25\uff01");return false}}})}}function select(){$("#uploadify").click()}function uploadComplete(evt){closeWait();var result=evt.target.responseText;if(result.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}result=eval("("+result+")");data=result.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){data=eval("("+data.rsData+")");setDocumentResult(data);docTotal=docMax;closeWindow()}else{alertFail("\u4e0a\u4f20\u6587\u4ef6\u5931\u8d25\uff01");return false}}function isImageFile(c){var a=["jpg","jpeg","bmp"];if(!isEmptyValue(c)){var d=c.substring(c.lastIndexOf(".")+1,c.length);if(!isEmptyValue(d)){for(var b=0;b<a.length;b++){if(d.toLowerCase()==a[b]){return true}}}}return false}function closeWindow(){CloseDiv("MyDiv","fade")}function setDocumentResult(c){var d=docTotal;if($("#image")!=undefined){$("#image").remove()}var b='<tr id="image" class="content_tr"><td>'+getCutStr(c.fileName)+'</td><td><span id="errMsg" style="color:red">'+c.ErrMsg+"</span></td>";if(c.ErrCode=="0"){b+='<td>A4</td><td><input type="text" size="5" id="_docnum" name="_docnum"onKeyUp="numVerify(this)" onBlur="numberBlur(this)" value="1" style="width:40px;border:1px solid #e4e4e4"/></td><td><span id="unit_price"></span></td>';b+='<td><a id="_del" href="javascript:void(0)" onclick="delDoc(this)">\u5220\u9664</a></td></tr>';$("#tbodyContent").append(b);$("#def_content_tr").hide();$("#fileName").val(c.fileName);$("#filePage").val(c.filePage);var a=getWidthAndHeight(c.img_width,c.img_height,150,150);if(c.idcardAB=="A"){$("#fileRealName1").val(c.fileRealName);$("#idCard_positive_img").attr("src","data:;base64,"+c.str_img);$("#idCard_positive_img").css("width",a[0]+"px");$("#idCard_positive_img").css("height",a[1]+"px")}else{if(c.idcardAB=="B"){$("#fileRealName").val(c.fileRealName);$("#idCard_reverse_img").attr("src","data:;base64,"+c.str_img);$("#idCard_reverse_img").css("width",a[0]+"px");$("#idCard_reverse_img").css("height",a[1]+"px")}}setBaseMoney()}else{b+='<td colspan="4"></td>';b+='<td><a id="_del" href="javascript:void(0)" onclick="delDoc(this)">\u5220\u9664</a>></td></tr>';$("#tbodyContent").append(b);$("#def_content_tr").hide()}}function numVerify(a){a.value=a.value.replace(/[^\d]/g,"");if(a.value==""||a.value=="0"){return}}function numberBlur(a){if(a.value==""||a.value=="0"){a.value="1"}}function setBaseMoney(){$.ajax({type:"post",async:false,url:"../print/getPrice.action",data:{size:"ID",color:"1",format:"0"},success:function(data){if(data.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}data=data.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){var rsData=eval("("+data.rsData+")");$("#baseMoney").val(parseFloat(rsData.price).toFixed(2));$("#unit_price").html(parseFloat(rsData.price).toFixed(2))}}})}function delDoc(){$("#image").remove();var a=$("#tbodyContent").children().length;if(a==2){$("#def_content_tr").show()}$("#idCard_positive_img").attr("src","../static/stamp_static/images1/idCard_positive_def.png");$("#idCard_reverse_img").attr("src","../static/stamp_static/images1/idCard_reverse_def.png");$("#idCard_positive_img, #idCard_reverse_img").css("width","150px").css("height","150px");$("#fileRealName1").val("");$("#fileRealName").val("");docTotal--}function saveTask(){if(docTotal<=0){alertWarning("\u8bf7\u9009\u62e9\u4e0a\u4f20\u7167\u7247\uff01");return false}var errTotal=0;if($("#errMsg").html().indexOf("\u6210\u529f")==-1){errTotal++}if(errTotal==docTotal){alertWarning("\u6ca1\u6709\u6210\u529f\u4e0a\u4f20\u7684\u7167\u7247\uff0c\u8bf7\u4e0a\u4f20\u6210\u529f\u540e\u518d\u6b21\u63d0\u4ea4\uff01");return false}if(isEmptyValue($("#fileRealName1").val())){alertFail("\u6ca1\u6709\u4e0a\u4f20\u8eab\u4efd\u8bc1\u6b63\u9762\u7167\uff01");return false}if(isEmptyValue($("#fileRealName").val())){alertFail("\u6ca1\u6709\u4e0a\u4f20\u8eab\u4efd\u8bc1\u53cd\u9762\u7167\uff01");return false}var number=$("#_docnum").val();var vag=/^\d+$/g;if((!vag.test(number))||(number<=0)){alertFail("\u8bf7\u8f93\u5165\u5927\u4e8e0\u7684\u6b63\u6574\u6570\u4efd\u6570");return false}startWait();var successNum=0;$("#number").val($("#_docnum").val());var formData=$("#formAjax").serialize();$.ajax({type:"post",async:false,url:"../print/createPrintTask.action",dataType:"json",data:formData,success:function(data){if(data.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}else{data=data.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){closeWait();successNum++}else{if(data.rsType==TYPE_RESULT.FAIL){closeWait();alertFail("\u521b\u5efa\u6253\u5370\u4efb\u52a1\u5931\u8d25\uff01");return false}else{if(data.rsType==TYPE_RESULT.WARN){var rsData=eval("("+data.rsData+")");closeWait();alertFail(rsData.ErrMsg);return false}}}}}});if(successNum==docTotal-errTotal){closeWait();delDoc();alertSuccess("\u6253\u5370\u4efb\u52a1\u63d0\u4ea4\u6210\u529f,\u8bf7\u5230\u4e91\u6253\u5370\u7ec8\u7aef\u673a\u53d6\u4ef6!")}};
