var docMax=10;var docTotal=0;var docDel=0;$(function(){$("#add_btn").click(function(){if(isEmptyValue($("#uId").text())){loginDiv();return false}validateIsOnline({confirmHandle:function(){$("#uploadify").click()}})});$("#submit_btn").click(function(){if(isEmptyValue($("#uId").text())){loginDiv();return false}validateIsOnline({confirmHandle:function(){saveTask()}})});if($("#uploadify").fileupload){$("#uploadify").fileupload({url:"../print/uploadFile.action",type:"post",dataType:"json",autoUpload:true,sequentialUploads:true,}).on("fileuploadadd",function(e,data){if(docTotal+data.originalFiles.length>docMax){alertFail("\u4e00\u6b21\u53ea\u80fd\u63d0\u4ea4"+docMax+"\u4e2a\u6587\u4ef6\uff01");return false}for(var i=0;i<data.originalFiles.length;i++){if(!isDocFile(data.originalFiles[i].name)){alertFail("\u9009\u62e9\u7684\u6587\u4ef6\u683c\u5f0f\u9519\u8bef");return false}if(data.originalFiles[i].size>83886080){alertFail("\u6587\u4ef6["+data.originalFiles[i].name+"]\u5927\u5c0f\u8d85\u51fa\u7cfb\u7edf\u9650\u5236\u768480M\u5927\u5c0f\uff01");return false}}startWait();$.blueimp.fileupload.prototype.options.add.call(this,e,data)}).on("fileuploaddone",function(e,data){data=data.result.resultInfo;setDocumentResult(eval("("+data.rsData+")"));if(docTotal>=docMax){$(".add_btn").hide()}}).on("fileuploadfail",function(e,data){closeWait();alertFail("\u4e0a\u4f20\u5931\u8d25\uff01")}).on("fileuploadstop",function(e,data){closeWait()})}else{$("#add_btn").hide();$("#uploadifyDiv").show();try{$("#uploadify").uploadify({swf:"../static/js/uploadify/uploadify.swf",uploader:"../print/uploadFileWithLowIe.action",buttonText:"\u6dfb\u52a0",buttonClass:"uploadifyClass",fileObjName:"file",height:30,width:100,fileTypeDesc:"\u652f\u6301\u7684\u683c\u5f0f\uff1a",fileTypeExts:"*.xls; *.xlsx; *.doc; *.docx; *.ppt; *.pptx;*.pdf; *.wps; *.wpt; *.et; *.ett; *.dpt; *.dps",auto:true,multi:true,queueSizeLimit:docMax,fileSizeLimit:"80MB",onInit:function(){$("#uploadify-queue").hide()},onFallback:function(){var p='<p>\u60a8\u672a\u5b89\u88c5FLASH\u63a7\u4ef6\uff0c\u65e0\u6cd5\u4e0a\u4f20\uff01\u8bf7<a style="color:#00a1ea;text-decoration: underline;"  href="https://get.adobe.com/cn/flashplayer/" target="_blank">\u5b89\u88c5FLASH\u63a7\u4ef6</a>\u6216\u5347\u7ea7\u6d4f\u89c8\u5668\u540e\u518d\u8bd5\u3002</p>';$("#def_content_tr td").append(p);$("#uploadifyDiv").hide();return false},onSelect:function(){if(isEmptyValue($("#uId").text())){loginDiv();return false}validateIsOnline({confirmHandle:function(){startWait()}})},onUploadSuccess:function(file,data,response){if(isEmptyValue(data)){alertFail("\u4e0a\u4f20\u6587\u4ef6\u5931\u8d25");return false}setDocumentResult(eval("("+data+")"));$("#uploadify").uploadify("settings","queueSizeLimit",docMax-docTotal);if(docTotal>=docMax){$("#uploadify").uploadify("disable",true);closeWait()}},onQueueComplete:function(){closeWait()},onUploadError:function(file,errorCode,errorMsg,errorString,swfuploadifyQueue){closeWait()}})}catch(e){closeWait()}}});function setDocumentResult(d){var g=docTotal;var c='<tr id="document'+g+'" class="document"><td>'+getCutStr(d.fileName)+'</td><td><span id="errMsg'+g+'" style="color:red">'+d.ErrMsg+"</span></td>";if(d.ErrCode=="0"){c+='<td><p><label><input type="radio" id="_doccolor1'+g+'" name="doccolor'+g+'"onclick="setColorAndFormat(this)" value="1" checked="checked"//><span style="font-weight: normal;cursor: pointer;">\u9ed1\u767d</span></label></p><p><label><input type="radio" id="_doccolor2'+g+'" name="doccolor'+g+'"onclick="setColorAndFormat(this)" value="0" ><span style="font-weight: normal;cursor: pointer;">\u5f69\u8272</span></label></p></td><td><p><label><input type="radio" id="_docformat1'+g+'" name="docformat'+g+'"onclick="setColorAndFormat(this)" value="0" checked="checked"/><span style="font-weight: normal;cursor: pointer;">\u5355\u9762</span></label></p><p><label><input type="radio" id="_docformat2'+g+'" name="docformat'+g+'"onclick="setColorAndFormat(this)" value="1"/><span style="font-weight: normal;cursor: pointer;">\u53cc\u9762</span></label></p></td><td><input type="text" size="5" id="_docpage'+g+'"onBlur="pageVerify(this)" name="_docpage'+g+'" style="width:40px;border:1px solid #e4e4e4;" value="1-'+d.filePage+'" mVal="'+d.filePage+'" /></td><td><input type="text" size="5" id="_docnum'+g+'" name="_docnum'+g+'"onKeyUp="numVerify(this)" onBlur="numberBlur(this)" value="1" style="width:40px;border:1px solid #e4e4e4;"/></td><td>A4</td><td><span id="unit_price'+g+'"></span></td><td><a id="_del'+g+'" href="javascript:void(0)" onclick="delDoc('+g+')">\u5220\u9664</a><div id="hidVal'+g+'" style="display:none"></div></td></tr>';$("#tbodyContent").append(c);$("#def_content_tr").hide();var a="<input id='docsize"+g+"' type='hidden' value=''>";var f="<input id='allpage"+g+"' type='hidden' value='"+d.filePage+"'>";var e="<input id='add_direction"+g+"' type='hidden' value='0'>";var h="<input id='fileName"+g+"' type='hidden' value='"+d.fileName+"'>";var b="<input id='add_pdffilename"+g+"' type='hidden' value='"+d.fileRealName+"'>";$("#hidVal"+g).append(a+e+h+b+f);setBaseMoney(g)}else{c+='<td colspan="6"></td>';c+='<td><a id="_del'+g+'" href="javascript:void(0)" onclick="delDoc('+g+')">\u5220\u9664</a><div id="hidVal'+g+'" style="display:none"></div></td></tr>';$("#tbodyContent").append(c);$("#def_content_tr").hide()}docTotal++;$("#documentNum").html("\u5171&nbsp;"+docTotal+"&nbsp;\u4e2a\u6587\u6863")}function getDocNum(c){var a=$("#_docpage"+c).val();if(a!=""&&a.indexOf("-")==-1){return 1}else{if(a!=""&&a.indexOf("-")!=-1){var b=a.split("-");var d=parseInt(b[1])-parseInt(b[0])+1;return d}}}function setBaseMoney(i,num){var a_color=$("input[name=doccolor"+i+"]:checked").val();var a_format=$("input:radio[name=docformat"+i+"]:checked").val();var a_size="A4";$("#docsize"+i).val(a_size);if(num==1){a_format=0}$.ajax({type:"post",async:false,url:"../print/getPrice.action",data:{size:a_size,color:a_color,format:a_format},success:function(data){if(data.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}data=data.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){var rsData=eval("("+data.rsData+")");$("#unit_price"+i).html(parseFloat(rsData.price).toFixed(2))}}})}function setColorAndFormat(a){var b=parseInt(a.getAttribute("id").charAt(a.getAttribute("id").length-1));if(a.getAttribute("id").substring(0,a.getAttribute("id").length-2)=="_doccolor"){if(a.value==0){$("#document"+b+" td:eq(3)").html('<label><input type="radio" id="_docformat1'+b+'" name="docformat'+b+'"onclick="setColorAndFormat(this)" value="0" checked="checked"/><span style="font-weight: normal;cursor: pointer;">\u5355\u9762</span></label>')}else{if(a.value==1){$("#document"+b+" td:eq(3)").html('<p><label><input type="radio" id="_docformat1'+b+'" name="docformat'+b+'"onclick="setColorAndFormat(this)" value="0" checked="checked"/><span style="font-weight: normal;cursor: pointer;">\u5355\u9762</span></label></p><p><label><input type="radio" id="_docformat2'+b+'" name="docformat'+b+'"onclick="setColorAndFormat(this)" value="1"/><span style="font-weight: normal;cursor: pointer;">\u53cc\u9762</span></label></p>')}}}setBaseMoney(b,getDocNum(b))}function pageVerify(c){c.value=c.value.replace(/[^-\d]/g,"");var b=c.value;if(b.indexOf("-")==-1){alertFail("\u9875\u7801\u683c\u5f0f\u9519\u8bef\uff0c\u8bf7\u91cd\u65b0\u8f93\u5165");c.value="1-"+c.getAttribute("mval");return}else{var a=b.split("-");if(a.length!=2){alertFail("\u9875\u7801\u683c\u5f0f\u9519\u8bef\uff0c\u8bf7\u91cd\u65b0\u8f93\u5165");c.value="1-"+c.getAttribute("mval");return}if(parseFloat(a[0])<1){alertFail("\u5f00\u59cb\u9875\u7801\u5fc5\u987b\u5927\u4e8e0!");c.value="1-"+c.getAttribute("mval");return}if(parseFloat(a[1])<parseFloat(a[0])){alertFail("\u7ed3\u675f\u9875\u7801\u5fc5\u987b\u5927\u4e8e\u7b49\u4e8e\u5f00\u59cb\u9875\u7801!");c.value="1-"+c.getAttribute("mval");return}if(parseFloat(a[1])>parseFloat(c.getAttribute("mval"))){alertFail("\u8f93\u5165\u7684\u9875\u7801\u4e0d\u80fd\u5927\u4e8e\u603b\u9875\u6570!");c.value="1-"+c.getAttribute("mval");return}}if(c.value==""){c.value="1-"+c.getAttribute("mval")}}function numVerify(a){a.value=a.value.replace(/[^\d]/g,"");if(a.value==""||a.value=="0"){return}}function numberBlur(a){if(a.value==""||a.value=="0"){a.value="1"}}function delDoc(c){$("#document"+c).remove();for(var b=(c+1);b<docTotal;b++){var a=b-1;$("#document"+b).attr("id","document"+a);$("#errMsg"+b).attr("id","errMsg"+a);$("#_doccolor1"+b).attr("id","_doccolor1"+a);$('input[name="doccolor'+b+'"]').attr("name","doccolor"+a);$("#_doccolor2"+b).attr("id","_doccolor2"+a);$("#_docformat1"+b).attr("id","_docformat1"+a);$('input[name="docformat'+b+'"]').attr("name","docformat"+a);$("#_docformat2"+b).attr("id","_docformat2"+a);$("#_docpage"+b).attr("id","_docpage"+a);$('input[name="_docpage'+b+'"]').attr("name","_docpage"+a);$("#_docnum"+b).attr("id","_docnum"+a);$('input[name="_docnum'+b+'"]').attr("name","_docnum"+a);$("#unit_price"+b).attr("id","unit_price"+a);$("#_del"+b).attr("onclick","delDoc("+a+")");$("#_del"+b).attr("id","_del"+a);$("#hidVal"+b).attr("id","hidVal"+a);$("#docsize"+b).attr("id","docsize"+a);$("#allpage"+b).attr("id","allpage"+a);$("#add_direction"+b).attr("id","add_direction"+a);$("#fileName"+b).attr("id","fileName"+a);$("#add_pdffilename"+b).attr("id","add_pdffilename"+a)}docTotal--;if(docTotal>0){$("#documentNum").html("\u5171&nbsp;"+docTotal+"&nbsp;\u4e2a\u6587\u6863")}else{$("#def_content_tr").show();$("#documentNum").html("&nbsp;")}if(!isLower10){$(".add_btn").show()}else{$("#uploadify").uploadify("disable",false);$("#uploadify").uploadify("settings","queueSizeLimit",docMax-docTotal)}}function delAllDoc(){docTotal=0;$(".document").remove();$("#def_content_tr").show();$("#documentNum").html("&nbsp;");if(!isLower10){$(".add_btn").show()}else{$("#uploadify").uploadify("disable",false);$("#uploadify").uploadify("settings","queueSizeLimit",docMax-docTotal)}}function isDocFile(c){var a=["doc","docx","pdf","xls","xlsx","ppt","pptx","wps","wpt","et","ett","dpt","dps"];if(!isEmptyValue(c)){var d=c.substring(c.lastIndexOf(".")+1,c.length);if(!isEmptyValue(d)){for(var b=0;b<a.length;b++){if(d.toLowerCase()==a[b]){return true}}}}return false}function saveTask(){var warnFlag=false;if(docTotal<=0){alertWarning("\u8bf7\u6dfb\u52a0\u6587\u6863\uff01");return false}var errTotal=0;for(var i=0;i<docTotal;i++){if($("#errMsg"+i).html().indexOf("\u6210\u529f")==-1){errTotal++}}if(errTotal==docTotal){alertWarning("\u6ca1\u6709\u6210\u529f\u4e0a\u4f20\u7684\u6587\u6863\uff0c\u8bf7\u4e0a\u4f20\u6210\u529f\u540e\u518d\u6b21\u63d0\u4ea4\uff01");return false}for(var i=0;i<docTotal;i++){if($("#errMsg"+i).html().indexOf("\u6210\u529f")==-1){continue}if($("input:radio[name=doccolor"+i+"]:checked").val()==undefined){alertWarning("\u8bf7\u9009\u62e9\u989c\u8272\uff01");return false}if($("input:radio[name=docformat"+i+"]:checked").val()==undefined){alertWarning("\u8bf7\u9009\u62e9\u5355\u53cc\u9762\uff01");return false}if(!savePageVerify($("#_docpage"+i).val(),$("#allpage"+i).val())){return false}}startWait();var present="";var successNum=0;var arr=new Array();for(var i=0;i<docTotal;i++){if($("#errMsg"+i).html().indexOf("\u6210\u529f")==-1){continue}var a_color=$("input:radio[name=doccolor"+i+"]:checked").val();var a_format=$("input:radio[name=docformat"+i+"]:checked").val();var a_size="A4";var allnums="";var pagesection="";var alldirection="";var filePage="";var pdfnames="";var uploadifyFileName="";allnums=$("#_docnum"+i).val();pagesection=$("#_docpage"+i).val();filePage=$("#allpage"+i).val();alldirection=$("#add_direction"+i).val();pdfnames=$("#add_pdffilename"+i).val();uploadifyFileName=$("#fileName"+i).val();$.ajax({type:"get",async:false,url:"../print/createPrintTask.action",dataType:"json",data:{fileName:uploadifyFileName,fileRealName:pdfnames,filePage:filePage,color:a_color,format:a_format,size:a_size,number:allnums,pagesection:pagesection},success:function(data){if(data.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}data=data.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){arr.push(i);successNum++}else{if(data.rsType==TYPE_RESULT.WARN){warnFlag=true;var rsData=eval("("+data.rsData+")");closeWait();alertFail(rsData.ErrMsg);return false}}}})}if(!warnFlag){if(successNum==docTotal-errTotal){closeWait();delAllDoc();alertSuccess("\u6253\u5370\u4efb\u52a1\u63d0\u4ea4\u6210\u529f,\u8bf7\u5230\u4e91\u6253\u5370\u7ec8\u7aef\u673a\u53d6\u4ef6!")}else{var len=arr.length;for(var j=0;j<len;j++){delDoc(j)}closeWait();alertFail("\u521b\u5efa\u6253\u5370\u4efb\u52a1\u5931\u8d25\uff01")}}}function savePageVerify(d,c){var b=/^[1-9]\d*-[1-9]\d*$/;if(!b.test(d)){alertFail("\u9875\u7801\u683c\u5f0f\u9519\u8bef\uff0c\u8bf7\u91cd\u65b0\u8f93\u5165");return false}var a=d.split("-");if(a.length!=2){alertFail("\u9875\u7801\u683c\u5f0f\u9519\u8bef\uff0c\u8bf7\u91cd\u65b0\u8f93\u5165");return false}if(parseFloat(a[0])<1){alertFail("\u5f00\u59cb\u9875\u7801\u5fc5\u987b\u5927\u4e8e0!");return false}if(parseFloat(a[1])<parseFloat(a[0])){alertFail("\u7ed3\u675f\u9875\u7801\u5fc5\u987b\u5927\u4e8e\u7b49\u4e8e\u5f00\u59cb\u9875\u7801!");return false}if(parseFloat(a[1])>c){alertFail("\u8f93\u5165\u7684\u9875\u7801\u4e0d\u80fd\u5927\u4e8e\u603b\u9875\u6570!");return false}return true};
